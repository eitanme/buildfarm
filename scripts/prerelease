#!/usr/bin/env python
import os
import sys
import yaml
import subprocess
import urllib
import string
import datetime
import fnmatch
import shutil
from xml.etree.ElementTree import ElementTree
from common import *


def main():

    if len(sys.argv) <= 2:
        print "Usage: %s ros_distro repository_name"%sys.argv[0]
        raise BuildException("Wrong number of parameters for prerelase script")
    else:
        ros_distro = sys.argv[1]
        repositories = sys.argv[2:]
        print "Working on distro %s and repositories %s"%(ros_distro, ', '.join(repositories))

    workspace = os.environ['WORKSPACE']
    tmpdir = os.path.join(workspace, 'tmp', 'prerelease_builds', str(datetime.datetime.now()).replace(' ','_').replace(':','.'))
    sourcespace = os.path.join(tmpdir, 'src')
    repositorybuildspace = os.path.join(tmpdir, 'build_repository')
    dependbuildspace = os.path.join(tmpdir, 'build_depend_on')
    os.makedirs(sourcespace)

    # parse the rosdistro file
    print "Parsing rosdistro file for %s"%ros_distro
    distro = RosDistro(ros_distro)
    for repository in repositories:
        print "Finding repo for repository %s"%repository
        if not repository in distro.repositories.keys():
            raise BuildException("Repository %s does not exist in Rosdistro"%repository)

    # Add ros to apt
    print "Add ros to apt sources"
    with open('/etc/apt/sources.list.d/ros-latest.list', 'w') as f:
        f.write("deb http://packages.ros.org/ros-shadow-fixed/ubuntu %s main"%os.environ['OS_PLATFORM'])
    call("wget http://packages.ros.org/ros.key -O %s/ros.key"%workspace)
    call("apt-key add %s/ros.key"%workspace)
    call("apt-get update")

    # install vcs tools
    print "Installing vcs tools"
    call("apt-get install mercurial subversion python-catkin-pkg python-support cmake --yes")

    # Create rosdep object
    print "Create rosdep object"
    rosdep = RosDepResolver(ros_distro)
    repositories_apt = [rosdep.to_apt(s) for s in repositories]

    # download the repositories from source
    print "Downloading all repositories"
    rosinstall = ""
    for repository in repositories:
        rosinstall += distro.repositories[repository].get_rosinstall_latest()
    print "rosinstall file for all repositories: \n %s"%rosinstall
    with open(workspace+"/repository.rosinstall", 'w') as f:
        f.write(rosinstall)
    print "Create rosinstall file for repositories %s"%(', '.join(repositories))
    call("rosinstall %s %s/repository.rosinstall --catkin"%(sourcespace, workspace))

    # get the repository dependencies
    print "Get all repository dependencies"
    dependencies = get_dependencies(sourcespace)
    if len(dependencies) > 0:
        print "Install all dependencies of repositories: %s"%(', '.join(dependencies))
        call("apt-get install %s --yes"%(' '.join([rosdep.to_apt(r) for r in dependencies])))
    else:
        print "Repositories have no dependencies"

    # replace the CMakeLists.txt file for repositories that use catkin
    print "Removing the CMakeLists.txt file generated by rosinstall"
    os.remove(os.path.join(sourcespace, 'CMakeLists.txt'))
    os.makedirs(repositorybuildspace)
    os.chdir(repositorybuildspace)
    print "Create a new CMakeLists.txt file using catkin"
    ros_env = get_ros_env('/opt/ros/%s/setup.bash'%ros_distro)
    call("catkin_init_workspace %s"%sourcespace, ros_env)
    call("cmake ../src/", ros_env)        
    ros_env = get_ros_env(os.path.join(repositorybuildspace, 'buildspace/setup.bash'))

    # build repositories
    print "Build repositories"
    call("make", ros_env)
    print "Test repositories"
    call("make run_tests", ros_env)

    # get repository depends-on list
    print "Get list of wet repositories that depend on %s"%repository
    apt = AptDepends(os.environ['OS_PLATFORM'], os.environ['ARCH'])
    depends_on_apt = []
    depends_on = []
    for repository_apt in repositories_apt:
        for d in apt.depends_on(repository_apt):
            if not d in depends_on_apt and not d in repositories_apt and rosdep.has_apt(d):
                depends_on_apt.append(d)
                depends_on.append(rosdep.to_repository(d))
    print "Depends_on list for repositories: %s"%(', '.join(depends_on))
    if len(depends_on) == 0:
        copy_test_results(workspace, repositorybuildspace)
        print "No wet groovy repositories in apt depend on this repository. Test finished here"
        return

    # install depends_on repositories from source
    rosinstall = yaml.dump([{'git': {'local-name': repository, 'uri': distro._repoinfo[repository].url, 'version': 'master'}} for repository in depends_on], default_style=False)
    print "Rosinstall for depends_on:\n %s"%rosinstall
    with open(workspace+"/depends_on.rosinstall", 'w') as f:
        f.write(rosinstall)
    print "Create rosinstall file for depends on"
    call("rosinstall --catkin %s %s/depends_on.rosinstall"%(sourcespace, workspace))

    # install all repository and system dependencies of the depends_on list
    print "Install all dependencies of the depends_on list"
    res = []
    for s in depends_on:
        dep = get_dependencies(os.path.join(sourcespace, s))
        for d in dep:
            if not d in res:
                res.append(d)

    res_apt = []
    for d_apt in [rosdep.to_apt(d) for d in res]:
        if not d_apt in repositories_apt and not d_apt in depends_on_apt:
            res_apt.append(d_apt)
    print "Dependencies of depends_on list are %s"%(', '.join(res_apt))
    if len(res_apt) > 0:
        call("apt-get install --yes %s"%(' '.join(res_apt)))


    # replace the CMakeLists.txt file again
    print "Removing the CMakeLists.txt file generated by rosinstall"
    os.remove(os.path.join(sourcespace, 'CMakeLists.txt'))
    os.makedirs(dependbuildspace)
    os.chdir(dependbuildspace)
    print "Create a new CMakeLists.txt file using catkin"
    call("catkin_init_workspace %s"%sourcespace, ros_env)
    call("cmake ..", ros_env)        
    ros_env = get_ros_env(os.path.join(dependbuildspace, 'buildspace/setup.bash'))

    # build repositories
    print "Build depends-on repositories"
    call("make", ros_env)
    print "Test depends-on repositories"
    call("make run_tests", ros_env)
    copy_test_results(workspace, dependbuildspace)
    print "right here"

if __name__ == '__main__':
    # global try
    try:
        main()
        print "Prerelease script finished cleanly"

    # global catch
    except BuildException as ex:
        print ex.msg

    except Exception as ex:
        print "Prerelease Test Failed. Check out the console output above for details."
        raise ex
